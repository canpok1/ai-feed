# アーキテクチャ概要

ai-feedは、Cobraフレームワークを使用したGo CLIアプリケーションで、クリーンアーキテクチャパターンを採用しています。

## ディレクトリ構成

```
ai-feed/
├── cmd/                        # Presentation Layer: CLIコマンドの定義
├── internal/
│   ├── app/                    # Application Layer: ユースケース
│   ├── domain/                 # Domain Layer: ビジネスルール
│   │   └── entity/             # エンティティ定義
│   └── infra/                  # Infrastructure Layer: 外部連携
│       ├── comment/            # AI連携実装
│       ├── fetch/              # フィード取得実装
│       ├── message/            # メッセージ送信実装
│       ├── profile/            # プロファイル管理実装
│       ├── selector/           # 記事選択実装
│       └── cache/              # キャッシュ実装
├── test/                       # テストコード
│   ├── e2e/                    # E2Eテスト
│   └── integration/            # 統合テスト
└── docs/                       # ドキュメント
```

## レイヤー構成と依存関係

```
┌──────────────────────────────────────────┐
│          Presentation Layer (cmd/)       │
├──────────────────────────────────────────┤
│          Application Layer (app/)        │
├──────────────────────────────────────────┤
│            Domain Layer (domain/)        │
├──────────────────────────────────────────┤
│        Infrastructure Layer (infra/)     │
└──────────────────────────────────────────┘

依存関係: cmd → app → domain ← infra
                        ↑
                   依存性逆転
```

- 上位層は下位層に依存できる（cmd → app → domain）
- infra層はdomain層のインターフェースを実装（依存性逆転）
- domain層は他のどの層にも依存しない

## 各層の責務

### 1. Presentation Layer（cmd/）

| 項目 | 内容 |
|------|------|
| **役割** | ユーザーインターフェースの提供 |
| **責務** | CLIコマンド定義、引数解析、app層への委譲、エラーメッセージ表示 |
| **許可される依存** | app層, infra層（Composition Root用）, Cobra |
| **禁止** | ビジネスロジック実装、設定ファイルのパース |

### 2. Application Layer（internal/app/）

| 項目 | 内容 |
|------|------|
| **役割** | ユースケースの実装とオーケストレーション |
| **責務** | 処理フローの実装、domain層インターフェース経由でのロジック呼び出し |
| **許可される依存** | domain層のみ |
| **禁止** | Cobraへの依存、infra層への依存、外部API直接呼び出し |

### 3. Domain Layer（internal/domain/）

| 項目 | 内容 |
|------|------|
| **役割** | ビジネスルールとコアロジックの定義 |
| **責務** | インターフェース定義、エンティティ・値オブジェクト、バリデーション |
| **許可される依存** | 標準ライブラリのみ |
| **禁止** | 他の層への依存、外部ライブラリ、I/O処理、ログ出力 |

### 4. Infrastructure Layer（internal/infra/）

| 項目 | 内容 |
|------|------|
| **役割** | 外部システムとの連携実装 |
| **責務** | domain層インターフェースの実装、外部API呼び出し、ファイルI/O |
| **許可される依存** | domain層, 外部ライブラリ |
| **禁止** | cmd層・app層への依存、ビジネスルール実装 |

## 依存性注入パターン

cmd層がComposition Rootとして、infra層のインスタンス生成を担当し、app層にはインターフェース経由で注入します。

詳細とコード例は [01_coding_rules.md](./01_coding_rules.md#5-依存性注入) を参照。

## エラーハンドリング

- **Sentinel Errorパターン**: app層でエラー定義、cmd層でユーザーフレンドリーメッセージに変換
- **エラー集約**: 複数処理のエラーは `errors.Join()` で集約

詳細とコード例は [01_coding_rules.md](./01_coding_rules.md#2-エラーハンドリング) を参照。

## 主要なアーキテクチャ上の決定事項

| 決定 | 理由 |
|------|------|
| **YAMLベース設定システム** | 人間が読み書きしやすく、階層的設定の表現が自然 |
| **ファクトリーパターンによるAI抽象化** | 複数AIプロバイダー対応、将来の拡張性確保 |
| **Viewerパターンによる出力先抽象化** | 複数出力先への同時送信、新規出力先の追加容易 |
| **slogによるログシステム** | 構造化ログの標準サポート、外部依存削減 |

## 拡張ポイント

### 新しいAIプロバイダーの追加

1. `internal/domain/comment.go` のインターフェースを実装
2. `internal/infra/comment/` に実装を追加
3. ファクトリーに登録

### 新しい出力先の追加

1. `internal/domain/message.go` のインターフェースを実装
2. `internal/infra/message/` に実装を追加
3. 設定構造体を拡張

### 新しいコマンドの追加

1. `cmd/` に新しいコマンドファイルを作成（フラグ解析のみ）
2. `internal/app/` にユースケースを実装
3. `cmd/root.go` でコマンドを登録

## セキュリティ考慮事項

- APIキーは環境変数または設定ファイルで管理（`.gitignore`で除外）
- URLの妥当性チェック
- プロンプトインジェクション対策
